name: build packages (kernel etc.) and push to the cache

on:
  push:
    branches:
      - 'main'
      - 'ci-test'
  schedule:
    - cron: "0 6 * * *"

jobs:
  packages:
    runs-on: namespace-profile-default-arm64
    continue-on-error: true
    strategy: &strategy
      # avoid building things twice if nixos-unstable and master contain the same derivations
      max-parallel: 1
      matrix:
        nixpkgs-override:
          - ""
          - "--override-input nixpkgs nixpkgs/nixos-unstable"
          - "--override-input nixpkgs nixpkgs/nixos-unstable-small"
          - "--override-input nixpkgs nixpkgs/master"
        event_name:
          - "${{ github.event_name }}"
        exclude:
          - nixpkgs-override: ""
            event_name: schedule
    steps: &steps
    - name: Checkout repository
      uses: actions/checkout@v5
    - name: Install nix
      uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - uses: cachix/cachix-action@v16
      with:
        name: nixos-apple-silicon
        authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        signingKey: "${{ secrets.CACHIX_SIGNING_KEY }}"
    - name: Build nix packages
      run: |
        nix run nixpkgs#nix-fast-build -- \
          --no-nom --skip-cached \
          -f .#packages \
          ${{ matrix.nixpkgs-override }} \
          ${{ matrix.nixpkgs-override != '' && '|| echo "::warning ::Build failed"' || '' }}

  # Also populate the cache for cross-compilation from x86_64 case
  # Do this as a separate matrix job, so that the max-parallel applies per architecture
  packages-cross:
    runs-on: namespace-profile-default
    continue-on-error: true
    strategy: *strategy
    steps: *steps
